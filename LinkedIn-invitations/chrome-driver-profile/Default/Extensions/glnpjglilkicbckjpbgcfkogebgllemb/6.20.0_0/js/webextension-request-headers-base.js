Okta.RequestHeadersBase=function(e,t,s,r){var n={};var i=Okta.Constants.Auth0;var a=Okta.fn.url.isOktaPage;var o=Okta.fn.url.isOktaAppSSOPath;var u=Okta.fn.url.replaceUrlPartsPath;var d=Okta.fn.api.prependPath;var l=Okta.fn.storage.siteFlowDataToFlow;var c=Okta.Q;var f=Okta.Url;var p=Okta._okta;var h=p.find;var v=p.isNumber;var g=p.each;var m=p.extend;var S=p.now;var k=p.partial;var O=p.size;var L=Okta.fn.browserType;var U=L.isSafariWebExt(t);var w="DOMAINS";var C=String.fromCharCode.apply(null,[79,75,84,65,95,65,67,67,79,85,78,84,95,87,72,73,84,69,95,76,73,83,84]);var R="DBG_PLUGIN_SETTINGS";var b="WebExtension::onAuth0BeforeRedirect: ";var I="WebExtension::onPOktaAppHomeRedirect: ";var A="WebExtension::onPOktaAppLoginRedirect: ";var E=[302];var P=[302];var _=1e3*60*30;var x=U?{urls:["https://*.auth0.com/authorize*"]}:{urls:["https://*.auth0.com/authorize?*"]};var y={urls:["https://personal.trexcloud.com/home/*/*/*","https://personal.okta.com/home/*/*/*"]};var T={urls:["https://personal.trexcloud.com/login/token/redirect?stateToken=*","https://personal.okta.com/login/token/redirect?stateToken=*"]};if(Okta.Config&&Okta.Config.allowLocalHostOrServer){y.urls.push("https://rain.okta1.com/home/*/*/*");y.urls.push("https://qa-plugin-fpa-idx.trexcloud.com/home/*/*/*");T.urls.push("https://rain.okta1.com/login/token/redirect?stateToken=*");T.urls.push("https://qa-plugin-fpa-idx.trexcloud.com/login/token/redirect?stateToken=*")}var q=function(e){var t=e.queryKey;return e.path==="/authorize"&&!!t.client_id&&!!t.redirect_uri&&!!t.scope&&!!t.state};var N=function(){return s.getPluginSettings().then(function(e){return e&&e.orgSettings&&e.orgSettings.pluginPersonalFastIdpEnabled})};var G=function(e){return r.makeGetRequestWithToken(e).then(function(e){if(e&&e.errorCode){Log.warn(I+"failed to obtain sites, error code: {0} and summary: {1}",e.errorCode,e.errorSummary);return}return c.all([s.setMonitoredSites(e.site),s.setAuthSites(e.authSite),s.setFormSitesNoPw(e.formSites),s.setSocialSites(e.socialSites)])}).fail(function(e){Log.warn(I+"failed to obtain sites, error: "+e)})};var z=function(a,e,o,t){var i=t?I:A;return r.makeGetRequest(e,t).then(function(e){if(e&&e.errorCode){Log.warn(i+"failed to obtain site-flow, error code: {0} and summary: {1}",e.errorCode,e.errorSummary);return}var t={flow:e,message:o.matchedSite.progressMessage,statusURI:o.matchedSite.callbackURI};var r=l(t);var n=m({},o,{requestComplete:true});Log.info(i+"successfully obtained site-flow, will update tab storage");delete M[a];return c.all([s.setCurrentFlow(a,r),s.setCurrentFastIdpApp(a,n)])}).fail(function(e){Log.warn(i+"failed to obtain site-flow, error: "+e)})};var D=function(e,t){if(!e.url||!e.redirectUrl||!v(e.tabId)||!v(e.statusCode)){Log.info(t+"url, redirectUrl, tabId or statusCode is missing");return false}if(!P.includes(e.statusCode)||e.method!="GET"){Log.info(t+"statusCode or method mismatch");return false}return true};var B=function(e){if(!D(e,I)){return false}if(!o(new f(e.redirectUrl))){Log.info(I+"redirectUrl is not appSSO url");return false}return true};var H=function(e){if(!D(e,A)){return false}if(a(new f(e.redirectUrl))){Log.info(A+"redirectUrl is still okta page, exit");return false}return true};var F=function(r){return s.getMonitoredSites().then(function(e){var t=h(e,function(e){return r.startsWith(e.siteURL)});return t})};n.HeaderConstants={EXTENDED_USER_AGENT_KEY:"X-Okta-User-Agent-Extended",PLUGIN_USER_AGENT_VALUE:"okta-browser-plugin/"+e,EXTENDED_PLUGIN_ACCOUNTS_USER_AGENT_KEY:"X-Okta-User-Agent-Account-Data"};n.getStorageCache=function(){return{domains:{key:w,val:null},dbgPluginSettings:{key:R,val:null},allowListedAccounts:{key:C,val:null}}};n.onAuth0BeforeRedirect=function(o){return s.getPluginSettings().then(function(e){if(!e||!e.orgSettings||!e.orgSettings.pluginSocialLoginEnabled){return}if(!v(o.tabId)){return}if(!E.includes(o.statusCode)||o.method!="GET"){Log.info(b+"statusCode or method mismatch");return}var t=new f(o.url);if(!q(t)){Log.info(b+"not a valid auth0 authorize call");return}if(i.POktaIdPDomain.includes(t.host)){Log.info(b+"authorize from POkta Idp, skip");return}var r=h(o.responseHeaders,function(e){return e.name.toLowerCase()==="x-auth0-requestid"});if(!r){Log.info(b+"no auth0 x-auth0-requestid header");return}var n=t.queryKey;var a={signOnMode:"oauth_authorize",audience:decodeURIComponent(n.audience),host:t.host,auth0Client:n.auth0Client,clientId:n.client_id,scope:decodeURIComponent(n.scope),redirectUri:decodeURIComponent(n.redirect_uri),timeStamp:o.timeStamp};return s.setCurrentSelfServiceAppCredentials(o.tabId,a)})};var M={};var W=function(e,t){g(M,function(e,t){if(e.timestamp+_<S()){delete M[t]}});t.timestamp=S();M[e]=t;Log.info("stored pOkta fastIdP info on tab {0}, current size: {1}",e,O(M))};n.onPOktaAppHomeRedirect=function(t){return N().then(function(e){if(!e){return}if(!B(t)){return}var n=t.redirectUrl;var a=new f(n);var o=t.tabId;var i={appSSOUrl:n};return s.setCurrentFastIdpApp(o,i).then(k(F,n)).then(function(e){if(!e){Log.warn(I+"siteUrl {0} is not in MonitoredSites, will try to resync app cache",n);var t=u(a,d("/sites"));return G(t).then(k(F,n))}return e}).then(function(e){if(!e){Log.warn(I+"siteUrl {0} is not in MonitoredSites after syncing app cache, exit",n);return}var t=m({},i,{matchedSite:e});W(o,t);var r=u(a,e.scriptURI);return z(o,r,t,true)})})};n.onPOktaAppLoginRedirect=function(s){return N().then(function(e){if(!e){return}if(!H(s)){return}var t=s.tabId;var r=M[t];if(!r||!r.appSSOUrl||!r.matchedSite){Log.warn(A+"missing fast IdP data in the previous redirection, exit");return}var n=r.appSSOUrl;var a=r.matchedSite;var o=new f(n);var i=u(o,a.scriptURI);return z(t,i,r,false).fin(function(){Log.info(A+"request done, deleting fastIdp data on tab");delete M[t]})})};n.initialize=function(){chrome.webRequest.onBeforeRedirect.addListener(n.onAuth0BeforeRedirect,x,["responseHeaders"]);chrome.webRequest.onBeforeRedirect.addListener(n.onPOktaAppHomeRedirect,y);chrome.webRequest.onBeforeRedirect.addListener(n.onPOktaAppLoginRedirect,T)};return n};